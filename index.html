<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Mini JDR Mobile</title>
<style>
body{font-family:Arial,sans-serif;background:#f5f5f5;padding:10px;text-align:center;margin:0;}
canvas{border:1px solid #000; background:#3399ff; display:block;margin:10px auto;max-width:95%;height:auto;}
button{padding:12px 16px;margin:5px;border-radius:8px;font-size:16px;min-width:120px;}
.log{background:#fff;border:1px solid #ccc;padding:10px;height:200px;overflow-y:auto;margin:10px 0;text-align:left;font-size:14px;}
.dice{display:inline-block;margin:2px;padding:5px 10px;border-radius:4px;font-weight:bold;}
.phys{background:#fdd;border:1px solid #f00;color:#900;}
.ment{background:#ddf;border:1px solid #00f;color:#009;}
.bonus{background:#fff;border:1px solid #000;color:#000;}
#exp-bar{width:100%;height:20px;background:#ccc;margin-top:5px;border-radius:5px;overflow:hidden;}
#exp-fill{height:100%;width:0%;background:#0a0;}
</style>
</head>
<body>
<h1>Mini Jeu de Rôle</h1>
<canvas id="gameCanvas" width="400" height="300"></canvas>
<div>
  <button id="btnPhys">Dé Physique</button>
  <button id="btnMent">Dé Mentale</button>
</div>
<div id="exp-bar"><div id="exp-fill"></div></div>
<div class="log" id="log"></div>

<script>
// -------------------- UTIL --------------------
function rand(s){return Math.floor(Math.random()*s)+1;}
function log(msg){const d=document.getElementById('log');d.innerHTML+=`<div>${msg}</div>`;d.scrollTop=d.scrollHeight;}
function logDice(rolls,css){const d=document.getElementById('log');d.innerHTML+=`<div>${rolls.map(r=>`<span class="dice ${css}">${r}</span>`).join(' ')}</div>`;}
function updateExpBar(exp,maxExp){document.getElementById('exp-fill').style.width=`${Math.min(100,exp/maxExp*100)}%`;}

// -------------------- REGISTRES --------------------
const REGISTRES = {
1:{PV:10,physDice:[6],mentDice:[6],bonusDice:[4],resPhys:[6],resMent:[6],exp:0,nextLevelExp:10},
4:{levelUpPV:'1D6 PV max ajouté à chaque niveau, PV restaurés'},
5:{enemyDice:'2 dé par niveau répartis aléatoirement entre action et résistance'},
6:{turns:'Tour du joueur puis ennemis, initiative 1D6'},
7:{interface:{canvasColor:'#3399ff',playerColor:'green',enemyColor:'red',mobile:true}},
9:{types:['Combat','Épreuve','Feu de camp']},
"Feu de camp":{rest:{D6:true,D20Check:true,failCombat:true}}
};

// -------------------- CLASSE PERSONNAGE --------------------
class Character{
  constructor(name,level=1,isEnemy=false){
    this.name=name;this.level=level;this.isEnemy=isEnemy;
    this.hpMax=REGISTRES[1].PV;this.hp=this.hpMax;
    this.physDice=[...REGISTRES[1].physDice];this.mentDice=[...REGISTRES[1].mentDice];this.bonusDice=[...REGISTRES[1].bonusDice];
    this.resPhys=[...REGISTRES[1].resPhys];this.resMent=[...REGISTRES[1].resMent];
    this.exp=0;this.nextLevelExp=REGISTRES[1].nextLevelExp;
    this.firstRest=true;
  }
  rollDice(arr,css){const r=arr.map(s=>rand(s));logDice(r,css);return r.reduce((a,b)=>a+b,0);}
  roll(type,isAction=true){return this.rollDice(isAction?(type==='phys'?this.physDice:this.mentDice):(type==='phys'?this.resPhys:this.resMent),isAction?(type==='phys'?'phys':'ment'):(type==='phys'?'phys':'ment'))+(isAction?this.rollDice(this.bonusDice,'bonus'):0);}
  takeDamage(dmg,type){const r=this.roll(type,false);if(r>=dmg){log(`${this.name} bloque (${r} >= ${dmg}) !`);return;}const t=dmg-r;this.hp-=t;if(this.hp<0)this.hp=0;log(`${this.name} subit ${t} dégâts, PV: ${this.hp}/${this.hpMax}`);}
  gainExp(amount){this.exp+=amount;log(`${this.name} gagne ${amount} EXP (${this.exp}/${this.nextLevelExp})`);updateExpBar(this.exp,this.nextLevelExp);if(this.exp>=this.nextLevelExp)this.levelUp();}
  levelUp(){this.level++;this.exp=0;this.nextLevelExp+=10;const hpGain=rand(6);this.hpMax+=hpGain;this.hp=this.hpMax;log(`${this.name} passe niveau ${this.level}, PV max +${hpGain}=${this.hpMax}`);setTimeout(()=>chooseDice(this),50);}
}

// -------------------- INIT --------------------
let player,enemy,canvas,ctx,currentEvent=null;
canvas=document.getElementById('gameCanvas');ctx=canvas.getContext('2d');

// -------------------- DESSIN --------------------
function drawScene(){
  ctx.fillStyle=REGISTRES[7].interface.canvasColor;ctx.fillRect(0,0,canvas.width,canvas.height);
  drawCharacter(player,50,150,'triangle',REGISTRES[7].interface.playerColor,player.hp,player.hpMax);
  if(enemy && currentEvent==='Combat')drawCharacter(enemy,300,160,'circle',REGISTRES[7].interface.enemyColor,enemy.hp,enemy.hpMax);
}
function drawCharacter(char,x,y,shape,color,hp,hpMax){
  ctx.fillStyle=color;
  if(shape==='triangle'){ctx.beginPath();ctx.moveTo(x,y-20);ctx.lineTo(x-20,y+20);ctx.lineTo(x+20,y+20);ctx.closePath();ctx.fill();}
  else ctx.beginPath(),ctx.arc(x,y,20,0,2*Math.PI),ctx.fill();
  ctx.fillStyle='red';ctx.fillRect(x-20,y+25,40*(hp/hpMax),5);
}

// -------------------- DÉS --------------------
document.getElementById('btnPhys').onclick=()=>handleAction('phys');
document.getElementById('btnMent').onclick=()=>handleAction('ment');
function handleAction(type){
  if(currentEvent==='Combat')combatTurn(type);
  if(currentEvent==='Épreuve')trial(type);
  if(currentEvent==='Feu de camp')restCamp();
}

// -------------------- POPUP DÉ --------------------
function chooseDice(character){
  let choice=parseInt(prompt("Choisissez un dé à ajouter : 0=Physique,1=Mental,2=Bonus,3=Résistance"));
  if(choice===0)character.physDice.push(6);
  if(choice===1)character.mentDice.push(6);
  if(choice===2)character.bonusDice.push(4);
  if(choice===3)character.resPhys.push(6);
  log(`${character.name} ajoute un dé ${['physique','mental','bonus','résistance'][choice]}`);
}

// -------------------- ÉVÉNEMENTS --------------------
function chooseEvent(){
  let choice=parseInt(prompt("Choisissez un événement : 0=Combat,1=Épreuve,2=Feu de camp"));
  currentEvent=REGISTRES[9].types[choice]; log(`Événement : ${currentEvent}`);
  if(currentEvent==='Combat')startCombat();
  if(currentEvent==='Épreuve')startTrial();
  if(currentEvent==='Feu de camp')startCamp();
  drawScene();
}

// -------------------- COMBAT --------------------
function spawnEnemy(){
  enemy=new Character('Ennemi',player.level,true);
  for(let i=0;i<2*enemy.level;i++){const r=rand(4)-1;if(r===0)enemy.physDice.push(6);if(r===1)enemy.mentDice.push(6);if(r===2)enemy.resPhys.push(6);if(r===3)enemy.resMent.push(6);}
  enemy.hp=6+player.level*2; log(`Ennemi niveau ${enemy.level} apparaît, PV:${enemy.hp}`);
}
function startCombat(){spawnEnemy();}
function combatTurn(type){
  if(player.hp<=0){log('Game Over');return;}
  if(enemy.hp<=0){log("Ennemi vaincu !");player.gainExp(5);chooseEvent();drawScene();return;}
  const pInit=rand(6), eInit=rand(6); log(`Initiative: Joueur ${pInit} vs Ennemi ${eInit}`);
  if(pInit>=eInit){enemy.takeDamage(player.roll(type));if(enemy.hp>0)player.takeDamage(enemy.roll('phys'));}
  else{player.takeDamage(enemy.roll('phys'));if(player.hp>0)enemy.takeDamage(player.roll(type));}
  drawScene();
}

// -------------------- ÉPREUVE --------------------
function startTrial(){log("Épreuve commence !");drawScene();}
function trial(type){
  const roll=player.roll(type);const success=roll>=rand(6)+3;log(`Épreuve ${type}: jet ${roll} -> ${success?'Réussi':'Échec'}`);
  if(success)player.gainExp(5);
  chooseEvent();drawScene();
}

// -------------------- FEU DE CAMP --------------------
function startCamp(){player.firstRest=true;log("Vous arrivez au feu de camp");drawScene();}
function restCamp(){
  if(player.firstRest){const heal=rand(6);player.hp=Math.min(player.hpMax,player.hp+heal);log(`Premier repos: +${heal} PV (${player.hp}/${player.hpMax})`);player.firstRest=false;}
  else{const check=rand(20);if(check>5){const heal=rand(6);player.hp=Math.min(player.hpMax,player.hp+heal);log(`Repos réussi: +${heal} PV (${player.hp}/${player.hpMax})`);}
  else{log(`Repos échoué ! Vous quittez le camp et combat commence.`);currentEvent='Combat';startCombat();}}
  drawScene();
}

// -------------------- DEMARRAGE --------------------
function startGame(){player=new Character('Héros');chooseEvent();}
startGame();
</script>
</body>
</html>