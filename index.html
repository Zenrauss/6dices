<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini JDR complet</title>
<style>
body { font-family: Arial, sans-serif; background:#1e1e2f; color:#f0f0f0; margin:0; padding:0; display:flex; flex-direction:column; height:100vh; }
h1 { text-align:center; color:#ffcc00; margin:10px 0; }
.buttons { display:flex; justify-content:center; gap:10px; margin-bottom:10px; }
button { padding:12px 20px; border-radius:12px; border:none; font-size:16px; cursor:pointer; font-weight:bold; transition:0.2s; }
button:hover { transform:scale(1.05); } button:active { transform:scale(0.95); }
.start-btn { background:#ffcc66; color:#000; }
.phys-btn { background:#ff6666; color:#fff; }
.ment-btn { background:#66b3ff; color:#fff; }
#battleCanvas { background:#0077cc; border-radius:12px; margin:0 10px 10px 10px; }
.log { flex:1; background:#2b2b3d; margin:0 10px 10px 10px; border-radius:12px; padding:10px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; }
.dice { display:inline-block; margin:2px; padding:10px 14px; border-radius:8px; font-weight:bold; font-size:18px; text-align:center; min-width:28px; animation:pop 0.2s; }
@keyframes pop {0%{transform:scale(0);}60%{transform:scale(1.2);}100%{transform:scale(1);}}
.phys { background:#ffcccc; border:2px solid #ff3333; color:#990000; }
.ment { background:#cce0ff; border:2px solid #3399ff; color:#003399; }
.bonus { background:#fff; border:2px solid #000; color:#000; }

#expBarContainer { width:90%; height:20px; background:#555; border-radius:10px; margin:0 auto 10px auto; overflow:hidden; }
#expBar { height:100%; width:0%; background:#ffcc00; }

#levelPopup, #eventPopup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:10; }
#levelPopup div, #eventPopup div { background:#222; padding:20px; border-radius:12px; text-align:center; }
.levelChoiceBtn, .eventChoiceBtn { margin:5px; padding:10px 15px; border-radius:8px; border:none; font-weight:bold; cursor:pointer; }
.levelChoiceBtn:hover, .eventChoiceBtn:hover { transform:scale(1.05); }
</style>
</head>
<body>
<h1>Mini Jeu de Rôle</h1>
<div class="buttons">
  <button class="start-btn" onclick="startGame()">Nouvelle Partie</button>
  <button class="phys-btn" onclick="playerAction('phys')">Dé Physique</button>
  <button class="ment-btn" onclick="playerAction('ment')">Dé Mentale</button>
</div>
<canvas id="battleCanvas" width="300" height="150"></canvas>
<div id="expBarContainer"><div id="expBar"></div></div>
<div class="log" id="log"></div>

<div id="levelPopup">
  <div>
    <h2>Choisis ton dé !</h2>
    <button class="levelChoiceBtn" onclick="chooseLevelDice('phys')">Physique</button>
    <button class="levelChoiceBtn" onclick="chooseLevelDice('ment')">Mentale</button>
    <button class="levelChoiceBtn" onclick="chooseLevelDice('bonus')">Bonus</button>
  </div>
</div>

<div id="eventPopup">
  <div>
    <h2>Choisis un événement :</h2>
    <button class="eventChoiceBtn" onclick="startEvent('combat')">Combat</button>
    <button class="eventChoiceBtn" onclick="startEvent('epreuve')">Épreuve</button>
    <button class="eventChoiceBtn" onclick="startEvent('feu')">Feu de camp</button>
  </div>
</div>

<script>
// --- Classe personnage selon registre ---
class Character {
  constructor(name, level=1) {
    this.name=name; this.level=level; this.hp=10; this.maxHp=10;
    this.physDice=[6]; this.mentDice=[6]; this.bonusDice=[4];
    this.resPhys=[6]; this.resMent=[6];
    this.exp=0; this.nextLevelExp=10;
  }
  rollDice(diceArr, cssClass){
    const rolls=diceArr.map(s=>Math.floor(Math.random()*s)+1);
    logDice(rolls, cssClass);
    return rolls.reduce((a,b)=>a+b,0);
  }
  rollAction(type){
    let base=0;
    if(type==='phys') base=this.rollDice(this.physDice,'phys');
    if(type==='ment') base=this.rollDice(this.mentDice,'ment');
    const bonus=this.rollDice(this.bonusDice,'bonus');
    return base+bonus;
  }
  rollResistance(type){ return type==='phys'?this.rollDice(this.resPhys,'phys'):this.rollDice(this.resMent,'ment'); }
  takeDamage(dmg,type){
    const resist=this.rollResistance(type);
    if(resist>=dmg){ log(`${this.name} bloque l'attaque (${resist} >= ${dmg}) !`); return; }
    const taken=dmg-resist; this.hp-=taken;
    log(`${this.name} subit ${taken} dégâts (${dmg}-${resist}), PV restants: ${this.hp}`);
    drawBattle(); checkPlayerDefeat();
  }
  gainExp(amount){ this.exp+=amount; log(`${this.name} gagne ${amount} EXP (total ${this.exp}/${this.nextLevelExp})`); updateExpBar(); if(this.exp>=this.nextLevelExp) showLevelPopup(); }
  levelUp(choice){
    this.level++; this.exp=0; this.nextLevelExp+=10;
    // PV max + 1D6
    const pvGain=Math.floor(Math.random()*6)+1;
    this.maxHp+=pvGain; this.hp=this.maxHp;
    if(choice==='phys') this.physDice.push(6);
    if(choice==='ment') this.mentDice.push(6);
    if(choice==='bonus') this.bonusDice.push(4);
    log(`${this.name} passe niveau ${this.level}, ajoute un dé ${choice} et gagne ${pvGain} PV max`);
    updateExpBar();
  }
}

// --- Log ---
function log(msg){ const div=document.getElementById('log'); const entry=document.createElement('div'); entry.textContent=msg; div.appendChild(entry); div.scrollTop=div.scrollHeight; }
function logDice(rolls,cssClass){ const div=document.getElementById('log'); const diceDiv=document.createElement('div'); rolls.forEach(r=>{ const span=document.createElement('span'); span.className=`dice ${cssClass}`; span.textContent=r; diceDiv.appendChild(span); }); div.appendChild(diceDiv); div.scrollTop=div.scrollHeight; }

// --- Canvas ---
const canvas=document.getElementById('battleCanvas'); const ctx=canvas.getContext('2d');
function drawBattle(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(player){
    // Joueur triangle vert
    ctx.fillStyle='green'; ctx.beginPath(); ctx.moveTo(50,120); ctx.lineTo(30,140); ctx.lineTo(70,140); ctx.closePath(); ctx.fill();
    // Barre PV joueur
    ctx.fillStyle='red'; ctx.fillRect(30,145,40*(player.hp/player.maxHp),8);
    ctx.strokeStyle='white'; ctx.strokeRect(30,145,40,8);
  }
  if(enemy){
    // Ennemi cercle rouge
    ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(250,130,15,0,Math.PI*2); ctx.fill();
    // Barre PV ennemi
    ctx.fillStyle='red'; ctx.fillRect(235,145,30*(enemy.hp/enemy.maxHp),8);
    ctx.strokeStyle='white'; ctx.strokeRect(235,145,30,8);
  }
}

// --- EXP Bar ---
function updateExpBar(){ const perc=Math.min((player.exp/player.nextLevelExp)*100,100); document.getElementById('expBar').style.width=perc+'%'; }

// --- Niveau Popup ---
function showLevelPopup(){ document.getElementById('levelPopup').style.display='flex'; }
function chooseLevelDice(choice){ player.levelUp(choice); document.getElementById('levelPopup').style.display='none'; startEventPopup(); drawBattle(); }

// --- Event Popup ---
function startEventPopup(){ document.getElementById('eventPopup').style.display='flex'; }
function startEvent(type){
  document.getElementById('eventPopup').style.display='none';
  if(type==='combat'){ spawnEnemy(); drawBattle(); }
  if(type==='epreuve'){ handleEpreuve(); }
  if(type==='feu'){ handleFeuCamp(); }
}

// --- Jeu ---
let player,enemy;
function startGame(){ 
  document.getElementById('log').innerHTML='';
  player=new Character('Héros'); spawnEnemy(); drawBattle(); updateExpBar();
  log('La partie commence !'); startEventPopup();
}

function spawnEnemy(){ 
  enemy=new Character('Ennemi',player.level); enemy.maxHp=6+player.level*2; enemy.hp=enemy.maxHp;
  log(`Un ennemi de niveau ${enemy.level} apparaît avec ${enemy.hp} PV !`); 
  drawBattle();
}

// --- Actions ---
function playerAction(type){
  if(!player) return;
  if(enemy && enemy.hp>0){
    const dmg=player.rollAction(type);
    enemy.takeDamage(dmg,'phys');
    if(enemy.hp>0){ const edmg=enemy.rollAction('phys'); player.takeDamage(edmg,'phys'); }
    else{ log('Ennemi vaincu !'); player.gainExp(5); startEventPopup(); }
  }
}

// --- Check Player Defeat ---
function checkPlayerDefeat(){ if(player.hp<=0){ log('Game Over'); player=null; drawBattle(); } }

// --- Épreuves ---
function handleEpreuve(){
  const type=Math.random()<0.5?'phys':'ment';
  log(`Épreuve ${type} ! Lance ton dé...`);
  const res=player.rollAction(type);
  if(res>=Math.ceil(Math.random()*6)){ log('Réussite ! Tu gagnes 5 EXP'); player.gainExp(5); }
  else{ log('Échec. Aucun gain.'); }
  startEventPopup();
}

// --- Feu de camps ---
function handleFeuCamp(){ const heal=Math.floor(Math.random()*5)+1; player.hp=Math.min(player.hp+heal,player.maxHp); log(`Feu de camp : tu récupères ${heal} PV`); drawBattle(); startEventPopup(); }

</script>
</body>
</html>